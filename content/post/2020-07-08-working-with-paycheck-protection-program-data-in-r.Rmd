---
title: Working with PayCheck Protection Program data in R
author: Conor Tompkins
date: '2020-07-08'
slug: working-with-paycheck-protection-program-data-in-r
categories:
  - R
  - politics
tags:
  - COVID
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

In this post, I walk through the process of reading in the data from the Paycheck Protection Program, and show some basic analyses that can be done.

Load packages and set up environment:
```{r}
library(tidyverse)
library(lubridate)
library(janitor)
library(hrbrthemes)

theme_set(theme_ipsum())

options(scipen = 999, digits = 4)
```

## Load and clean data

The data is available at this site: https://home.treasury.gov/policy-issues/cares-act/assistance-for-small-businesses/sba-paycheck-protection-program-loan-level-data

The data exists in numerous CSV files, separated by state and sometimes loan amount. 

This code chunk identifies all the CSV files in the folder, reads them in, and combines them.
```{r}
path <- "data/ppp"

#find all files in the folder that end in .csv
ppp <- list.files(path, full.names = TRUE, recursive = TRUE) %>% 
  keep(str_detect(., ".csv$")) %>% 
  #read each file with read_csv and combine them
  set_names() %>% 
  map_dfr(read_csv, col_types = cols(.default = "c"), .id = "file_name") %>% 
  clean_names()

glimpse(ppp)
```
This changes how the columns are interpreted, and separates the congressional district column into state and district. If the `district` value is blank, I replace it with `NA`.
```{r}
ppp <- ppp %>% 
  mutate(jobs_retained = as.numeric(jobs_retained),
         date_approved = mdy(date_approved),
         loan_amount = as.numeric(loan_amount),
         file_name = str_remove(file_name, path)) %>% 
  #separate cd column into state_2 and district
  separate(cd, into = c("state_2", "district"), remove = FALSE) %>% 
  #when district is blank, replace with NA
  mutate(district = case_when(district == "" ~ NA_character_,
                          district != "" ~ district))
```

There are cases where the value in the `state` column doesn't match the state embedded in the congressional district `cd` column. 
```{r}
#preview data where state doesn't match congressional district
ppp %>% 
  filter(file_name == "/All Data by State/Virginia/foia_up_to_150k_VA.csv") %>% 
  count(file_name, state, cd, state_2, sort = TRUE) %>% 
  mutate(flag_match = state == state_2) %>% 
  filter(flag_match == FALSE) %>% 
  slice(1:5)
```

There are only 414 rows where this occurs, and it is less than 1% of the dataset.
```{r}
#summarize cases where mismatch occurs
ppp %>% 
  mutate(flag_match = state == state_2) %>% 
  count(flag_match) %>% 
  mutate(pct_mismatch = n / sum(n),
         pct_mismatch = round(pct_mismatch, 4)) %>% 
  filter(flag_match == FALSE) %>% 
  arrange(-pct_mismatch)
```
Most of these bad rows are in the `foia_up_to_150k_other.csv` and `foia_150k_plus.csv` files.
```{r}
ppp %>% 
  mutate(flag_match = state == state_2) %>% 
  count(file_name, flag_match) %>% 
  group_by(file_name) %>% 
  mutate(pct_mismatch = n / sum(n),
         pct_mismatch = round(pct_mismatch, 4)) %>% 
  ungroup() %>% 
  filter(flag_match == FALSE) %>% 
  arrange(-pct_mismatch) %>% 
  slice(1:5)
```

I filter out the rows where the state doesn't match the congressional district.
```{r}
ppp <- ppp %>% 
  mutate(flag_match = state == state_2) %>% 
  filter(flag_match == TRUE)
```

## Analysis

First, split the data into 2 buckets. For loans above $150k, the SBA binned the loan amount instead of reporting the actual value.
```{r}
ppp_under_150 <- ppp %>% 
  filter(!str_detect(file_name, "150k plus"))

ppp_over_150 <- ppp %>% 
  filter(str_detect(file_name, "150k plus")) %>% 
  mutate(loan_range = str_sub(loan_range, 3, str_length(loan_range))) %>% 
  mutate(loan_range = fct_infreq(loan_range))
```


This shows that there are some missing and negative values in `loan_amount`. I filter out those values.
```{r}
ppp_under_150 %>% 
  mutate(loan_type = loan_amount > 0) %>% 
  count(loan_type)

ppp_under_150 <- ppp_under_150 %>% 
  filter(loan_amount > 0)
```

Among loans less than 150k, most are less than 21k, and the distribution is very heavily skewed to the right. 
```{r}
quantiles <- ppp_under_150 %>% 
  summarize(quantiles = quantile(loan_amount, probs = c(.25, .50, .75)), 
            probability = c("25th", "50th", "75th")) %>% 
  mutate(probability = as.factor(probability))

ppp_under_150 %>% 
  ggplot(aes(loan_amount)) +
  geom_histogram() +
  geom_vline(data = quantiles, aes(xintercept = quantiles, color = probability)) +
  scale_y_comma() +
  scale_x_comma(labels = scales::dollar) +
  labs(title = "SBA PPP Loans",
       subtitle = "Among loans less than $150k",
       x = "Loan amount",
       y = "Number of loans",
       color = "Quantile")
```
Loans under $150k make up the vast majority of all PPP loans.
```{r}
ppp_under_150_count <- ppp_under_150 %>% 
  mutate(loan_range = "Under $150,000") %>% 
  count(loan_range)

ppp_under_150_count %>% 
  bind_rows(ppp_over_150 %>% count(loan_range)) %>% 
  mutate(loan_range = fct_inorder(loan_range, n)) %>% 
  ggplot(aes(n, loan_range)) +
  geom_col() +
  labs(title = "SBA PPP Loans",
       subtitle = "All loans",
       x = "Number of loans",
       y = "Loan range") +
  scale_x_comma()
```
Loan approvals peaked in late May 2020, and picked up in July.
```{r}
ppp %>% 
  count(date_approved) %>% 
  ggplot(aes(date_approved, n)) +
  geom_point() +
  labs(title = "SBA PPP Loans",
       x = NULL,
       y = "Number of loans") +
  scale_y_comma()
```

Most states received similar proportions of small and large loans. Territories recieved more small loans and fewer large loans.
```{r}
ppp_under_150_count_state <- ppp_under_150 %>% 
  mutate(loan_range = "Under $150,000") %>% 
  count(state, loan_range)

state_loan_range <- ppp_under_150_count_state %>% 
  bind_rows(ppp_over_150 %>% count(state, loan_range)) %>% 
  mutate(loan_range = fct_inorder(loan_range, n)) %>% 
  group_by(state) %>% 
  mutate(pct_of_loans = n / sum(n)) %>% 
  ungroup()

state_loan_range %>% 
  filter(!is.na(state)) %>% 
  mutate(loan_range = fct_rev(loan_range),
         state = fct_reorder(state, n, .fun = sum)) %>% 
  ggplot(aes(pct_of_loans, state, fill = loan_range)) +
  geom_col() +
  scale_fill_viridis_d(direction = -1) +
  scale_x_percent() +
  labs(title = "SBA PPP Loans",
       subtitle = "% of loan range by state",
       x = "% of loans",
       y = NULL,
       fill = "Loan range")
```

Bigger loans tended to be approved earlier in the program.
```{r}
ppp_under_150_count_date <- ppp_under_150 %>% 
  mutate(loan_range = "Under $150,000") %>% 
  count(date_approved, loan_range)

date_loan_range <- ppp_under_150_count_date %>% 
  bind_rows(ppp_over_150 %>% count(date_approved, loan_range)) %>% 
  mutate(loan_range = fct_inorder(loan_range, n)) %>% 
  group_by(date_approved) %>% 
  mutate(pct_of_loans = n / sum(n)) %>% 
  ungroup()

date_loan_range %>% 
  ggplot(aes(date_approved, pct_of_loans, fill = loan_range)) +
  geom_area() +
  scale_x_date(expand = c(0,0)) +
  scale_y_percent(expand = c(0,0)) +
  labs(title = "SBA PPP Loans",
       x = NULL,
       y = "% of loans",
       fill = "Loan range")
```

### Map
```{r}
```


```{r}
```


```{r}
```


