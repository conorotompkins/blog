---
title: Ebird 2
author: Conor Tompkins
date: '2020-04-18'
slug: ebird-2
categories:
  - R
tags:
  - EBird
---



<div id="setup" class="section level2">
<h2>Setup</h2>
<pre class="r"><code>library(tidyverse)
library(lubridate)
library(vroom)
library(janitor)
library(rebird)
library(hrbrthemes)
library(ggrepel)
library(gganimate)
library(widyr)
library(tidygraph)
library(ggraph)
library(tidytext)

options(scipen = 999, digits = 2)

theme_set(theme_ipsum())

set.seed(1234)</code></pre>
</div>
<div id="load-and-filter-data" class="section level2">
<h2>Load and filter data</h2>
<pre class="r"><code>df &lt;- vroom(&quot;data/ebird2/ebd_US-PA-003_201001_202003_relFeb-2020.zip&quot;, delim = &quot;\t&quot;) %&gt;% 
  clean_names() %&gt;% 
  mutate_at(vars(observer_id, locality, observation_date, time_observations_started, protocol_type), str_replace_na, &quot;NA&quot;) %&gt;% 
  mutate(observation_date = ymd(observation_date),
         observation_count = as.numeric(str_replace(observation_count, &quot;X&quot;, as.character(NA))),
         observation_event_id = str_c(observer_id, locality, observation_date, time_observations_started)) %&gt;% 
  filter(all_species_reported == 1)</code></pre>
<pre class="r"><code>df_top_protocols &lt;- df %&gt;% 
  count(protocol_type, sort = TRUE) %&gt;% 
  slice(1:2)

df_top_protocols</code></pre>
<pre><code>## # A tibble: 2 x 2
##   protocol_type      n
##   &lt;chr&gt;          &lt;int&gt;
## 1 Traveling     318714
## 2 Stationary    178252</code></pre>
<pre class="r"><code>df &lt;- df %&gt;% 
  semi_join(df_top_protocols)</code></pre>
<pre class="r"><code>df %&gt;% 
  count(observation_date) %&gt;% 
  mutate(recent_observation = year(observation_date) &gt;= 2016,
         observation_date = ymd(observation_date)) %&gt;% 
  ggplot(aes(observation_date, n, color = recent_observation)) +
    geom_line() +
    scale_y_comma() +
    labs(y = &quot;Number of observations&quot;,
         x = &quot;Observation date&quot;)</code></pre>
<p><img src="/post/2020-04-18-ebird-2_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<pre class="r"><code>df &lt;- df %&gt;% 
  filter(year(observation_date) &gt;= 2016)</code></pre>
</div>
<div id="species-counts" class="section level2">
<h2>Species counts</h2>
<pre class="r"><code>df_counts &lt;- df %&gt;% 
  count(common_name, name = &quot;species_count&quot;, sort = TRUE)

df_counts</code></pre>
<pre><code>## # A tibble: 292 x 2
##    common_name            species_count
##    &lt;chr&gt;                          &lt;int&gt;
##  1 Northern Cardinal              21217
##  2 Song Sparrow                   17959
##  3 Blue Jay                       16714
##  4 Mourning Dove                  15756
##  5 American Robin                 15369
##  6 Tufted Titmouse                13954
##  7 American Crow                  13618
##  8 Carolina Wren                  12797
##  9 Red-bellied Woodpecker         12657
## 10 American Goldfinch             11746
## # ... with 282 more rows</code></pre>
<pre class="r"><code>df_counts %&gt;% 
  mutate(common_name = fct_reorder(common_name, species_count)) %&gt;% 
  slice(1:20) %&gt;% 
  ggplot(aes(species_count, common_name)) +
    geom_col()</code></pre>
<p><img src="/post/2020-04-18-ebird-2_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
<div id="species-correlations" class="section level2">
<h2>Species correlations</h2>
<pre class="r"><code>species_list &lt;- c(&quot;Northern Cardinal&quot;, &quot;Blue Jay&quot;)</code></pre>
<pre class="r"><code>df_pair_corr &lt;- df %&gt;% 
  pairwise_cor(common_name, observation_event_id, diag = FALSE, upper = FALSE)</code></pre>
<pre class="r"><code>df_pair_corr %&gt;% 
  filter(item1 %in% species_list) %&gt;% 
  drop_na(correlation) %&gt;% 
  arrange(item1, desc(correlation)) %&gt;% 
  group_by(item1) %&gt;% 
  slice(1:10) %&gt;% 
  ungroup() %&gt;% 
  mutate(item2 = reorder_within(x = item2, by = correlation, within = item1)) %&gt;% 
  ggplot(aes(correlation, item2, fill = item1)) +
    geom_col(alpha = .9) +
    facet_wrap(~item1, scales = &quot;free_y&quot;) +
    scale_y_reordered() +
    scale_fill_manual(values = c(&quot;blue&quot;, &quot;red&quot;)) +
    guides(fill = FALSE) +
    labs(x = &quot;Correlation&quot;,
         y = NULL)</code></pre>
<p><img src="/post/2020-04-18-ebird-2_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<pre class="r"><code>df_slopegraph &lt;- df_pair_corr %&gt;% 
  filter(item1 %in% species_list) %&gt;% 
  drop_na(correlation) %&gt;% 
  arrange(item1, desc(correlation)) %&gt;% 
  group_by(item1) %&gt;% 
  slice(1:20) %&gt;% 
  ungroup()</code></pre>
<pre class="r"><code>df_corr_diff &lt;- df_slopegraph %&gt;% 
  pivot_wider(names_from = item1, values_from = correlation, names_prefix = &quot;corr_&quot;) %&gt;% 
  clean_names() %&gt;% 
  mutate(corr_diff = abs(corr_blue_jay - corr_northern_cardinal)) %&gt;% 
  select(item2, corr_diff)

df_corr_diff</code></pre>
<pre><code>## # A tibble: 29 x 2
##    item2                   corr_diff
##    &lt;chr&gt;                       &lt;dbl&gt;
##  1 Tufted Titmouse            0.0258
##  2 Carolina Wren             NA     
##  3 Northern Cardinal         NA     
##  4 Red-bellied Woodpecker     0.0151
##  5 White-breasted Nuthatch    0.0143
##  6 Downy Woodpecker          NA     
##  7 Song Sparrow               0.121 
##  8 Northern Flicker           0.0245
##  9 Mourning Dove             NA     
## 10 Eastern Towhee            NA     
## # ... with 19 more rows</code></pre>
<pre class="r"><code>df_slopegraph %&gt;% 
  left_join(df_corr_diff) %&gt;% 
  ggplot(aes(item1, correlation)) +
    geom_line(aes(group = item2, color = corr_diff), size = 2) +
    geom_point(size = 2) +
    geom_text_repel(data = filter(df_slopegraph, item1 == species_list[2]),
                    aes(y = correlation, label = item2), direction = &quot;both&quot;, nudge_x = -.3, segment.alpha = .2) +
    geom_text_repel(data = filter(df_slopegraph, item1 == species_list[1]),
                    aes(y = correlation, label = item2), direction = &quot;both&quot;, nudge_x = .3, segment.alpha = .2) +
    scale_color_viridis_c(&quot;Absolute difference in correlation&quot;) +
    theme(panel.grid.minor.y = element_blank(),
          panel.grid.major.y = element_blank(),
          axis.title.x = element_blank())</code></pre>
<p><img src="/post/2020-04-18-ebird-2_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
</div>
<div id="network-graph" class="section level2">
<h2>Network Graph</h2>
<pre class="r"><code>graph_object_corr &lt;- df_pair_corr %&gt;% 
  #filter(common_name != &quot;gull sp.&quot;) %&gt;% 
  as_tbl_graph(directed = FALSE) %&gt;% 
  activate(edges) %&gt;% 
  filter(abs(correlation) &gt; .05) %&gt;% 
  activate(nodes) %&gt;% 
  filter(!node_is_isolated()) %&gt;% 
  left_join(df_counts, by = c(&quot;name&quot; = &quot;common_name&quot;))</code></pre>
<pre class="r"><code>plot &lt;- graph_object_corr %&gt;% 
    ggraph() +
    geom_edge_link(aes(width = correlation, alpha = correlation)) +
    geom_node_point(aes(size = species_count, alpha = species_count)) +
    scale_size_continuous(&quot;Total observations&quot;, labels = scales::comma) +
    scale_alpha_continuous(&quot;Total observations&quot;, labels = scales::comma) +
    scale_edge_alpha(&quot;Observations together&quot;, range = c(.01, .7), labels = scales::comma) +
    scale_edge_width(&quot;Observations together&quot;, range = c(.3, 2), labels = scales::comma) +
    theme_void()

plot</code></pre>
<p><img src="/post/2020-04-18-ebird-2_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<div id="highlight-species" class="section level3">
<h3>Highlight species</h3>
<pre class="r"><code>species_list &lt;- c(&quot;Northern Cardinal&quot;)

df_species_corr_nodes &lt;- graph_object_corr %&gt;% 
  activate(nodes) %&gt;% 
  as_tibble() %&gt;% 
  mutate(node_id = row_number()) %&gt;% 
  filter(name %in% species_list)</code></pre>
<pre class="r"><code>plot_corr &lt;- graph_object_corr %&gt;% 
  activate(nodes) %&gt;% 
  mutate(name_label = case_when(name %in% species_list ~ name,
                                TRUE ~ as.character(NA))) %&gt;% 
  activate(edges) %&gt;% 
  left_join(df_species_corr_nodes, by = c(&quot;from&quot; = &quot;node_id&quot;, &quot;to&quot; = &quot;node_id&quot;)) %&gt;% 
  mutate(species_flag = case_when(from %in% df_species_corr_nodes$node_id | to %in% df_species_corr_nodes$node_id ~ TRUE,
                                  TRUE ~ FALSE),
         name = case_when(is.na(name) ~ &quot;Other species&quot;,
                          TRUE ~ name)) %&gt;%
  ggraph() +
    geom_edge_link(aes(color = name, alpha = species_flag)) +
    geom_node_point(aes(shape = !is.na(name_label), size = !is.na(name_label), color = name_label)) +
    geom_node_label(aes(label = name_label, color = name_label), repel =  TRUE) +
    scale_edge_color_manual(values = c(&quot;red&quot;, &quot;black&quot;)) +
    scale_edge_alpha_discrete(range = c(.01, .7)) +
    scale_shape_manual(values = c(1, 19)) +
    scale_size_manual(values = c(2, 3)) +
    scale_color_discrete(&quot;Species&quot;, breaks = c(&quot;Blue Jay&quot;, &quot;Northern Cardinal&quot;, &quot;Other species&quot;)) +
    guides(edge_alpha = FALSE,
           edge_width = FALSE,
           size = FALSE,
           shape = FALSE) +
    theme_void()

plot_corr</code></pre>
<p><img src="/post/2020-04-18-ebird-2_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
</div>
</div>
